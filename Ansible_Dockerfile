FROM python

ARG SECRET

RUN apt update -y && apt install vim openssh-server ansible -y

RUN useradd ansible -m \
    && echo 'ansible:${SECRET}' | chpasswd \
    && usermod -aG sudo ansible \
    && echo 'ansible ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config \
    && sed -i 's/#   StrictHostKeyChecking ask/    StrictHostKeyChecking no/g' /etc/ssh/ssh_config \
    && service ssh restart

RUN mkdir /etc/ansible/ \
    && touch /etc/ansible/hosts \
    && echo "10.0.0.158 ansible_user=ubuntu ansible_ssh_private_key_file=/home/ansible/filinta.pem" > /etc/ansible/hosts

COPY filinta.pem /home/ansible/filinta.pem

RUN chmod 700 /home/ansible/filinta.pem \
    && chown -R ansible /home/ansible/filinta.pem

CMD ["bash"]

